name: vm-compat-nightly

on:
  schedule:
    - cron: "17 4 * * *"
  workflow_dispatch:

jobs:
  vm-compat:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - lane: floating
            vm_ref: main
          - lane: pinned
            vm_ref: 4158a42156a085a2b722205be951576fc01969b9
    steps:
      - name: Checkout t81-lang
        uses: actions/checkout@v4
        with:
          path: t81-lang

      - name: Checkout t81-vm
        uses: actions/checkout@v4
        with:
          repository: t81dev/t81-vm
          path: t81-vm
          ref: ${{ matrix.vm_ref }}

      - name: Runtime contract compatibility
        working-directory: t81-lang
        env:
          VM_COMPAT_LANE: ${{ matrix.lane }}
          T81_VM_DIR: ${{ github.workspace }}/t81-vm
        run: python3 scripts/check-vm-compat.py

      - name: Compiler/runtime roundtrip
        working-directory: t81-lang
        env:
          VM_COMPAT_LANE: ${{ matrix.lane }}
          T81_VM_DIR: ${{ github.workspace }}/t81-vm
        run: scripts/check-compiler-roundtrip.sh

  drift-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout t81-lang
        uses: actions/checkout@v4

      - name: Verify pinned baseline references
        run: |
          rg -n "runtime-contract-v0.5" docs/architecture/compatibility-matrix.md
          rg -n "4158a42156a085a2b722205be951576fc01969b9" docs/architecture/compatibility-matrix.md
