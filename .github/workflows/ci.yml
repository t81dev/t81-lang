name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  language-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout t81-lang
        uses: actions/checkout@v4

      - name: Run language-core checks
        run: scripts/check-lang-core.sh

      - name: Compatibility discipline
        if: github.event_name == 'pull_request'
        run: BASE_REF="${{ github.base_ref }}" scripts/check-compat-discipline.sh

  runtime-coupled-surface:
    runs-on: ubuntu-latest
    needs: language-core
    steps:
      - name: Checkout t81-lang
        uses: actions/checkout@v4

      - name: Validate runtime-coupled manifest
        run: scripts/check-runtime-coupled-tests.sh

  compiler-runtime-roundtrip:
    runs-on: ubuntu-latest
    needs: [language-core, runtime-coupled-surface]
    strategy:
      matrix:
        include:
          - lane: floating
            vm_ref: main
          - lane: pinned
            vm_ref: 30306b3
    steps:
      - name: Checkout t81-lang
        uses: actions/checkout@v4
        with:
          path: t81-lang

      - name: Checkout t81-vm
        uses: actions/checkout@v4
        with:
          repository: t81dev/t81-vm
          path: t81-vm
          ref: ${{ matrix.vm_ref }}

      - name: Run compiler/runtime artifact roundtrip
        env:
          VM_COMPAT_LANE: ${{ matrix.lane }}
          T81_VM_DIR: ${{ github.workspace }}/t81-vm
        run: scripts/check-compiler-roundtrip.sh
        working-directory: t81-lang

  runtime-contract-compat:
    runs-on: ubuntu-latest
    needs: [language-core, runtime-coupled-surface]
    strategy:
      matrix:
        include:
          - lane: floating
            vm_ref: main
          - lane: pinned
            vm_ref: 30306b3
    steps:
      - name: Checkout t81-lang
        uses: actions/checkout@v4
        with:
          path: t81-lang

      - name: Checkout t81-vm
        uses: actions/checkout@v4
        with:
          repository: t81dev/t81-vm
          path: t81-vm
          ref: ${{ matrix.vm_ref }}

      - name: Run runtime compatibility gate
        env:
          VM_COMPAT_LANE: ${{ matrix.lane }}
          T81_VM_DIR: ${{ github.workspace }}/t81-vm
        run: python3 scripts/check-vm-compat.py
        working-directory: t81-lang
